<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <link rel="stylesheet" type="text/css" href="/assets/static/admin/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/static/plugin/bootstrap-multitabs/multitabs.min.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/static/plugin/bootstrap-select/bootstrap-select.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/static/plugin/jquery-confirm/jquery-confirm.min.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/static/admin/css/style.min.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/static/plugin/bootstrap-fileinput/css/fileinput.min.css"/>
    <style>
        /* æ§åˆ¶æ–‡æœ¬æˆªæ–­ */
        .truncate-text {
            max-width: 200px; /* è®¾ç½®æœ€å¤§å®½åº¦ */
            white-space: nowrap; /* ä¸æ¢è¡Œ */
            overflow: hidden; /* è¶…å‡ºéƒ¨åˆ†éšè— */
            text-overflow: ellipsis; /* æ˜¾ç¤ºçœç•¥å· */
        }

        /* å›ºå®šæœ€åä¸€åˆ—ï¼ˆæ“ä½œåˆ—ï¼‰ */
        #siteTable th:last-child,
        #siteTable td:last-child {
            position: sticky;
            right: 0;
            background-color: white;
            z-index: 2;
            box-shadow: -2px 0 3px -2px rgba(0, 0, 0, 0.1); /* å¯é€‰ï¼šåŠ ä¸ªé˜´å½±æ›´æ˜æ˜¾ */
        }
    </style>
</head>

<body>
<div class="container-fluid p-t-15">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-toolbar d-flex flex-column flex-md-row justify-content-between">
                    <div class="toolbar-btn-action">
                        <a class="btn btn-primary m-r-5" href="/admin/site/add"><i class="mdi mdi-plus"></i> æ–°å¢</a>
                        <button class="btn btn-success m-r-5" id="exportBtn"><i class="mdi mdi-download"></i> å¯¼å‡º
                        </button>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="form-group m-b-0">
                            <input class="form-control" type="text" id="search-keyword" name="search-keyword"
                                   placeholder="è¯·è¾“å…¥ç½‘å€æ ‡é¢˜..."/>
                        </div>
                        <div class="form-group m-b-0 m-l-10">
                            <select class="form-control selectpicker" id="category-filter" data-live-search="true">
                                <option value="">å…¨éƒ¨åˆ†ç±»</option>
                                <!-- åˆ†ç±»é€‰é¡¹å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                            </select>
                        </div>
                        <div class="form-group m-b-0 m-l-10">
                            <button class="btn btn-outline-success btn-search" type="submit">æœç´¢</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" role="alert">æ³¨ğŸ“¢: å‹¾é€‰"æ‹‰å–å¤±è´¥æ—¶ä»…ä¿å­˜ç½‘å€"åŠŸèƒ½å¯¹åº”è¡ŒèƒŒæ™¯è‰²é«˜äº®,
                        è®°å¾—ç‚¹å‡»ç¼–è¾‘ä¿®æ”¹å‘¦!
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered" id="siteTable">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Logo</th>
                                <th>åç§°ç®€ä»‹</th>
                                <th>é“¾æ¥</th>
                                <th>åˆ†ç±»</th>
                                <th>åˆ›å»ºæ—¥æœŸ</th>
                                <th>æ›´æ–°æ—¥æœŸ</th>
                                <th style="text-align: center; ">çŠ¶æ€</th>
                                <th style="text-align: center;">æ’åº</th> <!-- æ–°å¢æ’åºåˆ— -->
                                <th style="text-align: center; ">æ“ä½œ</th>
                            </tr>
                            </thead>
                            <tbody class="tbody"></tbody>
                        </table>
                    </div>
                    <ul class="pagination" id="paginationDiv"></ul>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="/assets/static/admin/js/jquery.min.js"></script>
<script type="text/javascript" src="/assets/static/admin/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript" src="/assets/static/plugin/bootstrap-maxlength/bootstrap-maxlength.min.js"></script>
<script type="text/javascript" src="/assets/static/plugin/jquery-confirm/jquery-confirm.min.js"></script>
<script type="text/javascript" src="/assets/static/plugin/bootstrap-select/bootstrap-select.min.js"></script>
<script type="text/javascript" src="/assets/static/plugin/bootstrap-select/i18n/defaults-zh_CN.min.js"></script>
<script type="text/javascript" src="/assets/static/plugin/bootstrap-multitabs/multitabs.min.js"></script>
<script type="text/javascript" src="/assets/static/admin/js/httpclient.js"></script>
<script type="text/javascript" src="/assets/static/admin/js/jquery.pagination.js"></script>
<script src="/assets/static/plugin/bootstrap-fileinput/js/fileinput.min.js"></script>
<script src="/assets/static/plugin/bootstrap-fileinput/js/locales/zh.min.js"></script>
<script type="text/javascript" src="/assets/static/admin/js/utils.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        // åŠ è½½åˆ†ç±»é€‰é¡¹
        loadCategories();
        // ç›‘å¬åˆ†ç±»é€‰æ‹©å™¨çš„å˜åŒ–
        $(document).on('change', '#category-filter', function () {
            const categoryId = $(this).val(); // è·å–é€‰ä¸­çš„åˆ†ç±»ID
            const searchKeyword = $("#search-keyword").val(); // è·å–æœç´¢å…³é”®å­—
            getPageListData(1, 10, searchKeyword, categoryId); // é‡æ–°åŠ è½½æ•°æ®
        });
        // åŠ è½½åˆ—è¡¨é¡µæ•°æ®
        getPageListData();

        // åŠ è½½åˆ†ç±»é€‰é¡¹çš„å‡½æ•°
        function loadCategories() {
            AjaxForm(
                "GET",
                "/api/admin/category",
                {},
                function () {
                },
                function (data) {
                    const categoryFilter = $("#category-filter");
                    categoryFilter.empty();
                    categoryFilter.append('<option value="">å…¨éƒ¨åˆ†ç±»</option>');
                    $.each(data.list, function (index, category) {
                        categoryFilter.append('<option value="' + category.id + '">' + category.name + '</option>');
                    });
                    categoryFilter.selectpicker('refresh');
                },
                function (response) {
                    AjaxError(response);
                }
            );
        }

        // è·å–åˆ†é¡µæ•°æ®çš„å‡½æ•°
        function getPageListData(page = 1, page_size = 10, search = null, category_id = null, url = "/api/admin/site") {
            if (parseInt(page) < 1) {
                page = 1;
            }
            if (parseInt(page_size) < 1) {
                page_size = 10;
            }
            AjaxForm(
                "GET",
                url,
                {page: page, page_size: page_size, search: search, category_id: category_id},
                function () {
                },
                function (data) {
                    if (data.list.length > 0) {
                        var totalNum = data.pagination.total; // æ€»æ¡æ•°
                        var pageNum = Math.ceil(totalNum / data.pagination.per_page_count); // åˆ†é¡µçš„æ€»é¡µæ•°
                        $("#paginationDiv").pagination({
                            current: data.pagination.current_page,
                            pageCount: pageNum,
                            coping: true,
                            homePage: 'é¦–é¡µ',
                            endPage: 'æœ«é¡µ',
                            mode: 'fixed',
                            prevContent: 'ä¸Šä¸€é¡µ',
                            nextContent: 'ä¸‹ä¸€é¡µ',
                            activeCls: 'pageActive',
                            prevCls: 'pagePrev',
                            nextCls: 'pageNext',
                            callback: function (api) {
                                $(".tbody").html("");
                                getPageListData(api.getCurrent(), 10, $("#search-keyword").val(), $("#category-filter").val());
                            }
                        });
                        $(".tbody").html("");
                        $.each(data.list, function (index, value) {
                            let showUsedBadge;
                            let optionUsedName;
                            if (value.is_used) {
                                optionUsedName = 'ç¦ç”¨';
                                showUsedBadge = '<span class="badge badge-success">å¯ç”¨</span></td>'
                            } else {
                                optionUsedName = 'å¯ç”¨';
                                showUsedBadge = '<span class="badge badge-danger">ç¦ç”¨</span></td>'
                            }

                            let trHtml = '<tr>';
                            if (value.url === value.title) { // å¦‚æœurlå’Œtitleç›¸åŒï¼Œåˆ™æ˜¾ç¤ºè­¦å‘Šæ ·å¼
                                trHtml = '<tr class="table-warning">'
                            }

                            const tr = trHtml +
                                '<td>' + value.id + '</td>' +
                                '<td><img class="lozad img-circle" width="30" src="data:image/png;base64,' + value.icon + '" data-loaded="true"></td>' +
                                '<td class="truncate-text"><span title="' + value.title + '">' + value.title + '</span></td>' +
                                '<td class="truncate-text">' +
                                '<a href="' + value.url + '" target="_blank" title="' + value.url + '">' + value.url + '</a>' +
                                '</td>' +
                                '<td>' + value.category + '</td>' +
                                '<td>' + value.created_at + '</td>' +
                                '<td>' + value.updated_at + '</td>' +
                                '<td style="text-align: center;">' + showUsedBadge + '</td>' +
                                '<td style="text-align: center;">' + value.sort + '</td>' + <!-- æ–°å¢æ’åºåˆ— -->
                                '<td style="text-align: center;">' +
                                '<div class="btn-group"  id="siteTable">' +
                                '    <a class="btn btn-xs btn-default btn-sync" href="#!" title=""' +
                                '                                           data-id="' + value.id + '"' +
                                '                                           data-title="' + value.title + '"' +
                                '                                           data-toggle="tooltip" data-original-title="ä¸€é”®åŒæ­¥">ä¸€é”®åŒæ­¥</a>' +
                                '    <a class="btn btn-xs btn-default btn-detail" href="#!" title=""' +
                                '                                           data-title="' + value.title + '"' +
                                '                                           data-description="' + value.description + '"' +
                                '                                           data-toggle="tooltip" data-original-title="è¯¦æƒ…">è¯¦æƒ…</a>' +
                                '    <a class="btn btn-xs btn-default btn-option" href="#!" title=""' +
                                '                                           data-id="' + value.id + '"' +
                                '                                           data-is-used="' + value.is_used + '"' +
                                '                                           data-toggle="tooltip" data-original-title="' + optionUsedName + '">' + optionUsedName + '</a>' +
                                '    <a class="btn btn-xs btn-default btn-confirm" href="#!" title=""' +
                                '                                           data-id="' + value.id + '"' +
                                '                                           data-toggle="tooltip" data-original-title="åˆ é™¤">åˆ é™¤</a>' +
                                '    <a class="btn btn-xs btn-default btn-update" href="#!" title=""' +
                                '                                           data-id="' + value.id + '"' +
                                '                                           data-thumb="' + value.thumb + '"' +
                                '                                           data-url="' + value.url + '"' +
                                '                                           data-category="' + value.category + '"' +
                                '                                           data-title="' + value.title + '"' +
                                '                                           data-description="' + value.description + '"' +
                                '                                           data-category_id="' + value.category_id + '"' +
                                '                                           data-sort_order="' + value.sort + '"' + <!-- æ–°å¢æ’åºæ•°æ® -->
                                '                                           data-toggle="tooltip" data-original-title="ç¼–è¾‘">ç¼–è¾‘</a>' +
                                '</div>' +
                                '</td>' +
                                '</tr>';
                            $(".tbody").append(tr);
                        });
                    } else {
                        // æ•°æ®ä¸ºç©º
                        $(".tbody").html("");
                        $(".tbody").append('<tr><td colspan="7" style="text-align: center">æš‚æ— æ•°æ®</td></tr>');
                    }
                },
                function (response) {
                    AjaxError(response);
                }
            );
        }

        // ä¸€é”®åŒæ­¥
        $(document).on('click', '.btn-sync', function () {
            const id = $(this).attr('data-id');
            const business_title = $(this).attr('data-title');
            $.confirm({
                title: 'è°¨æ…æ“ä½œ',
                content: 'ç¡®è®¤è¦ <strong style="color: red">ä¸€é”®åŒæ­¥ </strong>ï¼š' + business_title + ' å—ï¼Ÿ',
                icon: 'mdi mdi-alert',
                animation: 'scale',
                closeAnimation: 'zoom',
                buttons: {
                    okay: {
                        text: 'ç¡®è®¤',
                        keys: ['enter'],
                        btnClass: 'btn-orange',
                        action: function () {
                            AjaxForm(
                                "GET",
                                '/api/admin/site/sync/' + id,
                                "",
                                function () {
                                },
                                function (data) {
                                    $.alert({
                                        title: 'æ“ä½œæˆåŠŸ',
                                        icon: 'mdi mdi-check-decagram',
                                        type: 'green',
                                        content: 'ç¼–å·ï¼š' + data.id + ' å·²åŒæ­¥ã€‚',
                                        buttons: {
                                            okay: {
                                                text: 'å…³é—­',
                                                action: function () {
                                                    const currentPage = document.querySelector('.page-link.pageActive').textContent;
                                                    getPageListData(parseInt(currentPage), 10, document.getElementById('search-keyword').value, $("#category-filter").val());
                                                }
                                            }
                                        }
                                    });
                                },
                                function (response) {
                                    AjaxError(response);
                                }
                            );
                        }
                    },
                    cancel: {
                        text: 'å–æ¶ˆ',
                        keys: ['ctrl', 'shift'],
                    }
                }
            });
        });
        // è¯¦æƒ…
        $(document).on('click', '.btn-detail', function () {
            const business_title = $(this).attr('data-title');
            const business_description = $(this).attr('data-description');
            $.alert({
                title: 'è¯¦æƒ…',
                content: 'åç§°ç®€ä»‹ ï¼š' + business_title + '<br/>æè¿°ï¼š' + business_description,
                type: 'green',
                animation: 'scale',
                draggable: true,
            });
        });
        // å¯ç”¨/ç¦ç”¨
        $(document).on('click', '.btn-option', function () {
            const id = $(this).attr('data-id');
            const isUsed = $(this).attr('data-is-used');
            var tipMessage = "";
            var wantUsed = false;
            if (isUsed === "true") { // true=å½“å‰ä¸ºå¯ç”¨çŠ¶æ€ï¼Œéœ€è¦æ”¹æˆç¦ç”¨
                tipMessage = "ç¦ç”¨";
                wantUsed = false;
            }
            if (isUsed === "false") {
                tipMessage = "å¯ç”¨";
                wantUsed = true;
            }
            const patchData = {
                id: id,
                is_used: wantUsed,
            };
            $.confirm({
                title: 'è°¨æ…æ“ä½œ',
                content: 'ç¡®è®¤è¦ <strong style="color: red">' + tipMessage + '</strong> å—ï¼Ÿ',
                icon: 'mdi mdi-alert',
                animation: 'scale',
                closeAnimation: 'zoom',
                buttons: {
                    okay: {
                        text: 'ç¡®è®¤',
                        keys: ['enter'],
                        btnClass: 'btn-orange',
                        action: function () {
                            AjaxForm(
                                "PUT",
                                "/api/admin/site/" + id,
                                patchData,
                                function () {
                                },
                                function (data) {
                                    $.alert({
                                        title: 'æ“ä½œæˆåŠŸ',
                                        icon: 'mdi mdi-check-decagram',
                                        type: 'green',
                                        content: 'ç¼–å·ï¼š' + data.id + ' å·²' + tipMessage + 'ã€‚',
                                        buttons: {
                                            okay: {
                                                text: 'å…³é—­',
                                                action: function () {
                                                    const currentPage = document.querySelector('.page-link.pageActive').textContent;
                                                    getPageListData(parseInt(currentPage), 10, document.getElementById('search-keyword').value, $("#category-filter").val());
                                                }
                                            }
                                        }
                                    });
                                },
                                function (response) {
                                    AjaxError(response);
                                }
                            );
                        }
                    },
                    cancel: {
                        text: 'å–æ¶ˆ',
                        keys: ['ctrl', 'shift'],
                    }
                }
            });
        });
        // åˆ é™¤
        $(document).on('click', '.btn-confirm', function () {
            const id = $(this).attr('data-id');
            $.confirm({
                title: 'è°¨æ…æ“ä½œ',
                content: 'ç¡®è®¤è¦ <strong style="color: red">åˆ é™¤</strong> å—ï¼Ÿ',
                icon: 'mdi mdi-alert',
                animation: 'scale',
                closeAnimation: 'zoom',
                buttons: {
                    okay: {
                        text: 'ç¡®è®¤',
                        keys: ['enter'],
                        btnClass: 'btn-orange',
                        action: function () {
                            AjaxForm(
                                "DELETE",
                                '/api/admin/site/' + id,
                                "",
                                function () {
                                },
                                function (data) {
                                    $.alert({
                                        title: 'æ“ä½œæˆåŠŸ',
                                        icon: 'mdi mdi-check-decagram',
                                        type: 'green',
                                        content: 'ç¼–å·ï¼š' + data.id + ' å·²åˆ é™¤ã€‚',
                                        buttons: {
                                            okay: {
                                                text: 'å…³é—­',
                                                action: function () {
                                                    const currentPage = document.querySelector('.page-link.pageActive').textContent;
                                                    getPageListData(parseInt(currentPage), 10, document.getElementById('search-keyword').value, $("#category-filter").val());
                                                }
                                            }
                                        }
                                    });
                                },
                                function (response) {
                                    AjaxError(response);
                                }
                            );
                        }
                    },
                    cancel: {
                        text: 'å–æ¶ˆ',
                        keys: ['ctrl', 'shift'],
                    }
                }
            });
        });
        // ç¼–è¾‘
        $(document).on('click', '.btn-update', function () {
            const id = $(this).attr('data-id');
            const thumb = $(this).attr('data-thumb');
            const title = $(this).attr('data-title');
            const url = $(this).attr('data-url');
            const description = $(this).attr('data-description');
            const category_id = $(this).attr('data-category_id');
            const sort = $(this).attr('data-sort_order'); // è·å–æ’åºæ•°æ®

            $.confirm({
                title: 'ç¼–è¾‘ç½‘ç«™',
                //content: 'url:form.html',  // ä¹Ÿå¯ä»¥é‡‡ç”¨urlå½¢å¼
                content: '<div class="form-group p-1 mb-0">' +
                    '<div class="input-group mb-3">' +
                    '<div class="input-group-prepend">' +
                    '<span class="input-group-text">åˆ†ç±»</span>' +
                    '</div>' +
                    '<select class="form-control selectpicker col-lg-5" id="category_id" data-width="auto" data-live-search="true" data-size="5"></select>' +
                    '</div>' +
                    '<div>' +
                    '<input  style="display:none"  autofocus="" class="form-control" type="text"  maxLength="200" id="id" value="' + id + '">' +
                    '</div>' +
                    '<div>' +
                    '<label class="control-label">Logo</label>' +
                    '<input  autofocus="" class="form-control" type="text"  maxLength="200" id="thumb" placeholder="è¯·è¾“å…¥Logoé“¾æ¥" value="">' +
                    '</div>' +
                    '<input id="file" name="file" type="file" class="file">' +
                    '<div>' +
                    '  <label class="control-label">åç§°</label>' +
                    '  <input autofocus="" type="text"  placeholder="è¯·è¾“å…¥ç½‘ç«™åç§°" class="form-control"  id="title" value="' + title + '">' +
                    '</div>' +
                    '<div>' +
                    '  <label class="control-label">é“¾æ¥</label>' +
                    '  <input autofocus="" type="text"  placeholder="è¯·è¾“å…¥ç½‘ç«™åœ°å€" class="form-control"  id="url" value="' + url + '">' +
                    '</div>' +
                    '<div>' +
                    '  <label class="control-label">ç½‘ç«™æè¿°</label>' +
                    '  <textarea class="form-control" maxlength="225" rows="2" id="description" placeholder="ç½‘ç«™æè¿°"  id="title">' + description + '</textarea>' +
                    '</div>' +
                    '<div>' +
                    '  <label>æ’åº</label>' +
                    '  <small class="help-block">(ç›¸åŒåˆ†ç±»ä¸‹ç½‘ç«™æ’åº)</small>' +
                    '  <input autofocus="" type="number"  placeholder="è¯·è¾“å…¥æ’åºå€¼" class="form-control"  id="sort_order" value="' + sort + '">' + <!-- æ–°å¢æ’åºè¾“å…¥æ¡† -->
                    '</div>',
                onOpen: function () {
                    // bootstrap-fileinput åˆå§‹åŒ–å¼•å¯¼æ–‡ä»¶è¾“å…¥æ’ä»¶
                    $('#file').fileinput({
                        language: 'zh',
                        showPreview: false,  // æ˜¾ç¤ºé¢„è§ˆ
                        maxFileSize: 2500,  // æœ€å¤§æ–‡ä»¶å¤§å°
                        initialPreviewAsData: true,
                        initialPreview: [],  // åˆå§‹é¢„è§ˆæ•°æ®
                        allowedFileExtensions: ["jpg", "png"],  // å…è®¸çš„æ–‡ä»¶æ‰©å±•å
                        browseLabel: 'é€‰æ‹©æ–‡ä»¶', // è‡ªå®šä¹‰æµè§ˆæŒ‰é’®æ ‡ç­¾
                        removeLabel: 'åˆ é™¤', // è‡ªå®šä¹‰åˆ é™¤æŒ‰é’®æ ‡ç­¾
                        showUpload: false // éšè—ä¸Šä¼ æŒ‰é’®
                    });
                    AjaxFormNoAsync(
                        "GET",
                        "/api/admin/category",
                        "",
                        function () {
                        },
                        function (data) {
                            const treeData = buildTree(data.list);// å°†æ‰å¹³åŒ–æ•°æ®è½¬æ¢ä¸ºæ ‘å½¢ç»“æ„
                            const selectElement = document.getElementById('category_id');// è·å– <select> å…ƒç´ 
                            renderTreeToSelect(treeData, selectElement, 0, [parseInt(category_id)]);  // æ¸²æŸ“æ ‘å½¢ç»“æ„åˆ° <select>
                            $("#category_id").selectpicker('refresh');// åˆå§‹åŒ– Bootstrap Select
                        },
                        function (response) {
                            AjaxError(response);
                        }
                    );
                },
                buttons: {
                    sayMyName: {
                        text: 'ç¡®è®¤',
                        btnClass: 'btn-orange',
                        action: function () {
                            const thumb = $("#thumb").val();
                            const title = $("#title").val();
                            if (title === "") {
                                $.alert({
                                    title: 'æ¸©é¦¨æç¤º',
                                    icon: 'mdi mdi-alert',
                                    type: 'orange',
                                    content: 'è¯·è¾“å…¥ç½‘ç«™åç§°ã€‚',
                                });
                                return false;
                            }
                            const url = $("#url").val();
                            if (url === "") {
                                $.alert({
                                    title: 'æ¸©é¦¨æç¤º',
                                    icon: 'mdi mdi-alert',
                                    type: 'orange',
                                    content: 'è¯·è¾“å…¥ç½‘ç«™é“¾æ¥ã€‚',
                                });
                                return false;
                            }
                            const description = $("#description").val();
                            if (description === "") {
                                $.alert({
                                    title: 'æ¸©é¦¨æç¤º',
                                    icon: 'mdi mdi-alert',
                                    type: 'orange',
                                    content: 'è¯·è¾“å…¥ç½‘ç«™æè¿°ã€‚',
                                });
                                return false;
                            }
                            const formData = new FormData();
                            formData.append('id', id);
                            formData.append('thumb', thumb);
                            formData.append('title', title);
                            formData.append('url', url);
                            formData.append('description', description);
                            formData.append('file', $("#file")[0].files[0]);
                            formData.append('category_id', $("#category_id").val());
                            formData.append('sort', $("#sort_order").val()); // æ·»åŠ æ’åºå€¼

                            AjaxMultipartForm(
                                "PUT",
                                "/api/admin/site/" + id,
                                formData,
                                function () {
                                },
                                function (data) {
                                    $.alert({
                                        title: 'æ“ä½œæˆåŠŸ',
                                        icon: 'mdi mdi-check-decagram',
                                        type: 'green',
                                        content: 'ç¼–å·ï¼š' + data.id + ' ä¿®æ”¹å®Œæˆã€‚',
                                        buttons: {
                                            okay: {
                                                text: 'å…³é—­',
                                                action: function () {
                                                    const currentPage = $(".page-link.pageActive").text(); // è·å–å½“å‰é¡µç 
                                                    getPageListData(currentPage, 10, $("#search-keyword").val(), $("#category-filter").val()); // é‡æ–°åŠ è½½å½“å‰é¡µæ•°æ®
                                                }
                                            }
                                        }
                                    });
                                },
                                function (response) {
                                    AjaxError(response);
                                }
                            );
                        }
                    },
                    'å–æ¶ˆ': function () {
                    }
                }
            });
        });
        // æœç´¢
        $(document).on('click', '.btn-search', function () {
            getPageListData(0, 0, $("#search-keyword").val(), $("#category-filter").val())
        })
    })
</script>
<script>
    $(document).ready(function () {
        $(document).on('click', '#exportBtn', function () {
            const searchKeyword = $("#search-keyword").val();
            exportData(searchKeyword);            // å‘èµ·å¯¼å‡ºè¯·æ±‚
        });

        function exportData(searchKeyword) {
            let url = "/api/admin/site/export";
            if (searchKeyword) {
                url += "?search=" + encodeURIComponent(searchKeyword);
            }
            // å‘èµ· GET è¯·æ±‚
            $.ajax({
                url: url,
                method: "GET",
                xhrFields: {
                    responseType: 'blob' // é‡è¦ï¼šå‘Šè¯‰ jQuery è¿”å›çš„æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶
                },
                success: function (data, status, xhr) {
                    const contentDisposition = xhr.getResponseHeader('Content-Disposition');// è·å–æ–‡ä»¶åï¼ˆä»å“åº”å¤´ä¸­æå–ï¼‰
                    let fileName = "sites.xlsx"; // é»˜è®¤æ–‡ä»¶å
                    if (contentDisposition && contentDisposition.includes('filename=')) {
                        fileName = contentDisposition.split('filename=')[1].trim();
                    }
                    const link = document.createElement('a');
                    link.href = window.URL.createObjectURL(data); // å°†æ–‡ä»¶æµè½¬æ¢ä¸º URL
                    link.download = fileName; // è®¾ç½®ä¸‹è½½æ–‡ä»¶å
                    document.body.appendChild(link);
                    link.click(); // è§¦å‘ä¸‹è½½
                    document.body.removeChild(link); // ç§»é™¤é“¾æ¥å…ƒç´ 
                },
                error: function (xhr, status, error) {
                    $.alert({
                        title: 'å¯¼å‡ºå¤±è´¥',
                        icon: 'mdi mdi-alert',
                        type: 'red',
                        content: 'å¯¼å‡ºæ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼š' + error,
                    });
                }
            });
        }
    });
</script>
</body>
</html>
